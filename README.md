[![Build Status](https://travis-ci.org/agalitsyn/yagoda.svg?branch=master)](https://travis-ci.org/agalitsyn/yagoda)

# Yet another great ops deployment automation

![yagoda](https://dl.dropboxusercontent.com/u/29807088/yagoda.png)

Yagoda project is an experiment, which allows to deploy Apache Cassandra into Kubernetes.

Differences from k8s team [example](https://github.com/kubernetes/kubernetes/blob/release-1.2/examples/cassandra/README.md):
* Host networking setup. Why answered [here](https://github.com/agalitsyn/yagoda/issues/2).
* Cassandra describes in k8s resources as daemon set. Why answered [here](https://github.com/agalitsyn/yagoda/issues/7).
* No custom [SeedProvider](https://github.com/kubernetes/kubernetes/blob/release-1.2/examples/cassandra/java/src/io/k8s/cassandra/KubernetesSeedProvider.java), gossip discovery based on headless service, seeds selects by labeling and node selectors by k8s. Why answered [here](https://github.com/agalitsyn/yagoda/issues/3).

## Requirements

* Python 3.5.*
* Vagrant (as newer as possible)
* Virtualbox (as newer as possible)
* Docker (as newer as possible)
* Kubectl

For good performance, better to have hardware like:
* 8 GB of RAM
* 4 cores CPU
* 80 GB free on disk
* SSD

## Installation

### Python 3.5

OSX already have python 3.5 in [homebrew](https://github.com/Homebrew/legacy-homebrew/blob/master/Library/Formula/python3.rb).

```sh
$ brew install python3
```

Ubuntu 16.04 already have it in distributuion.


Ubuntu 14.04, Debian 8:

```
$ bash tools/get-python-35.sh
```

### Virtualbox

OSX, Windows, download and install [Virtualbox](https://www.virtualbox.org/wiki/Downloads).

Ubuntu, Debian can use same way, or install from repository:

```
$ sudo apt-get install virtualbox virtualbox-guest-additions-iso virtualbox-dkms virtualbox-ext-pack
```

### Vagrant

OSX, Windows, Linux, download and install [Vagrant](https://www.vagrantup.com/downloads.html).


### Docker

For installing docker see [reference](https://docs.docker.com/engine/installation/linux/ubuntulinux/).

OSX-specific case, see [Docker-machine on OSX](https://docs.docker.com/engine/installation/mac/#from-your-shell).


#### Configure Docker

Yagoda uses docker registry inside kubernetes cluster. For pushing purposes, needs to configure insecure registry. Otherwise you will see this [issue](https://docs.docker.com/registry/insecure/#failing).

For linux & systemd see [doc](https://docs.docker.com/engine/admin/systemd)

For example, my settings is:

```
# cat /etc/systemd/system/docker.service.d/insecure-registry.conf
[Service]
ExecStart=
ExecStart=/usr/bin/docker daemon -H fd:// --insecure-registry 172.17.4.101:30100
```

### Kubectl

See reference [doc](http://kubernetes.io/docs/getting-started-guides/docker/#download-kubectl).

## Run locally on vagrant

Install cluster

```
$ date; time bash k8s-vagrant.sh
```

Install python virtualenv

```
$ tox
$ source .tox/py35/bin/activate
```

Setup environment for `kubectl`, needs proper `KUBECONFIG` env variable value.

```
$ eval $(bash set-kubeconfig-vagrant.sh)
```

Provision cassandra cluster

```
$ python3.5 cassandra-manage.py create
```

Validate cassandra cluster

```
$ python3.5 cassandra-manage.py validate
```

*Note*: recreating a cluster - drop any autogenerated files (keys, configs) and virtual machines completely.`


### Other cassandra actions

See
```
$ python3.5 cassandra-manage.py --help
```

Execute queries using cqlsh

```
$ tools/k8s-cassandra.sh cqlsh
```

Launch nodetool

```
$ tools/k8s-cassandra.sh status
```

### Monitoring

Nodes covered by prometheus node-exporter.

Cassandra covered by:
* jmx-exporter
* k8s server-side liveness and statuses probes, see `cassandra/k8s/daemonset.yaml`.

Useful command:
```
$ kubectl describe pods cassandra
```

Output:
```
Ready:              True
Restart Count:      0
Liveness:           exec [/opt/yagoda/bin/cassandra-check] delay=30s timeout=5s period=10s #success=1 #failure=3
Readiness:          exec [cqlsh --execute HELP] delay=30s timeout=5s period=10s #success=1 #failure=3
```

## Development

See `tools/k8s-docker.sh`

